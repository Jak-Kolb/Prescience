<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Prescience Dashboard</title>
    <script src="https://unpkg.com/htmx.org@1.9.12"></script>
    <link rel="stylesheet" href="/static/ui.css" />
  </head>
  <body>
    <main class="container">
      <header class="topbar">
        <h1>Prescience</h1>
        <p>Line <code id="line-id">{{ line_id }}</code> | Pairing required: <code>{{ pairing_required }}</code></p>
      </header>

      <section class="stats-grid">
        <article class="card metric">
          <div class="label">Total Count</div>
          <div class="value" id="total-count">{{ live.totals.overall }}</div>
        </article>
        <article class="card metric">
          <div class="label">Unknown Count</div>
          <div class="value" id="unknown-count">{{ live.totals.unknown }}</div>
        </article>
        <article class="card metric">
          <div class="label">Throughput (units/min)</div>
          <div class="value" id="throughput">{{ '%.2f'|format(live.throughput.units_per_min) }}</div>
        </article>
        <article class="card metric">
          <div class="label">Recent Alerts</div>
          <div class="value" id="alerts-recent">{{ live.alerts_recent }}</div>
        </article>
      </section>

      <section class="grid-2">
        <article class="card">
          <h2>New SKU Enrollment</h2>
          <p class="muted">
            Upload a ~1 minute product video showing all sides, varied backgrounds/environments,
            and a few no-product scenes for better false-positive suppression.
          </p>
          <form action="/ui/sku/enroll" method="post" enctype="multipart/form-data" class="stack-form">
            <input type="text" name="sku" placeholder="sku name (e.g. chickfila_sauce)" required />
            <input type="file" name="video" accept="video/*" required />
            <button type="submit">Start Enrollment</button>
          </form>
          <div id="action-result"></div>
        </article>

        <article class="card">
          <h2>Line Health</h2>
          <div class="kv"><span>Last heartbeat</span><code id="hb-time">{{ live.device_health.last_heartbeat or 'n/a' }}</code></div>
          <div class="kv"><span>FPS</span><code id="hb-fps">{{ live.device_health.fps or 'n/a' }}</code></div>
          <div class="kv"><span>Brightness</span><code id="hb-bright">{{ live.device_health.brightness or 'n/a' }}</code></div>
          <div class="kv"><span>Blur</span><code id="hb-blur">{{ live.device_health.blur_score or 'n/a' }}</code></div>
          <h3>By SKU</h3>
          <ul id="sku-list"></ul>
        </article>
      </section>

      <section class="card">
        <h2>SKU Workspace</h2>
        {% if skus %}
          <div class="sku-grid">
            {% for sku in skus %}
              <article class="sku-card">
                <div class="sku-head">
                  <h3><code>{{ sku.sku_id }}</code></h3>
                  <span class="pill">{{ sku.latest_version or "no model yet" }}</span>
                </div>
                <div class="muted">Versions: {% if sku.model_versions %}{{ sku.model_versions|join(", ") }}{% else %}none{% endif %}</div>

                <form action="/ui/sku/{{ sku.sku_id }}/append-train" method="post" enctype="multipart/form-data" class="inline-form">
                  <input type="file" name="video" accept="video/*" required />
                  <button type="submit">Add Video + Quick Train</button>
                </form>

                <div class="inline-actions">
                  <button
                    hx-post="/ui/sku/{{ sku.sku_id }}/train/full"
                    hx-target="#action-result"
                    hx-swap="innerHTML"
                    {% if not sku.full_train_ready %}disabled{% endif %}
                  >
                    Full Train
                  </button>
                  <a class="button ghost" href="/ui/tracking?sku_id={{ sku.sku_id }}&line_id={{ line_id }}">Define Zone + Run Tracking</a>
                </div>

                <form
                  hx-post="/ui/skus/delete"
                  hx-target="#action-result"
                  hx-swap="innerHTML"
                  hx-confirm="Delete SKU '{{ sku.sku_id }}' and all related videos/models/data?"
                  class="inline-form"
                >
                  <input type="hidden" name="sku_id" value="{{ sku.sku_id }}" />
                  <button type="submit" class="danger">Delete SKU</button>
                </form>
              </article>
            {% endfor %}
          </div>
        {% else %}
          <p class="muted">No SKUs yet. Start by enrolling your first SKU above.</p>
        {% endif %}
      </section>

      <section class="grid-2">
        <article class="card">
          <h2>Workflow Jobs</h2>
          <div id="job-list" class="job-list"></div>
        </article>

        <article class="card">
          <h2>Recent Onboarding Sessions</h2>
          <ul class="session-list">
            {% for session in sessions %}
              <li>
                <a href="/ui/onboarding/{{ session.session_id }}"><code>{{ session.sku_id }}</code> {{ session.version_tag }}</a>
                <span class="muted">({{ session.state }})</span>
              </li>
            {% endfor %}
          </ul>
        </article>
      </section>

      <section class="card">
        <h2>Run Controls</h2>
        <div class="row">
          <form hx-post="/ui/runs/start" hx-target="#action-result" hx-swap="innerHTML">
            <input type="text" name="line_id" value="{{ line_id }}" required />
            <input type="text" name="device_id" value="device-1" required />
            <input type="text" name="run_id" placeholder="optional run id" />
            <button type="submit">Start Run</button>
          </form>
          <form hx-post="/ui/runs/stop" hx-target="#action-result" hx-swap="innerHTML">
            <input type="text" name="run_id" placeholder="run id" required />
            <button type="submit">Stop Run</button>
          </form>
        </div>
      </section>
    </main>

    <script src="/static/ui.js"></script>
    <script>
      window.PRESCIENCE_BOOTSTRAP = {
        lineId: {{ line_id | tojson }},
        initialLive: {{ live | tojson }},
      };
    </script>
  </body>
</html>
